<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ì–´ë–»ê²Œ?">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3299/3299954.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–´ë–»ê²Œ? ğŸš® - ë¶„ë¦¬ìˆ˜ê±° ê°€ì´ë“œ</title>
    <style>
        /* [ë””ìì¸ ì‹œìŠ¤í…œ & ê¸°ë³¸ ì„¤ì •] */
        :root {
            --bg-color: #FFFFFF;
            --main-green: #2E8B57; /* SeaGreen */
            --soft-green: #90EE90; /* LightGreen */
            --pastel-gray: #F0F2F0; /* íšŒë°±ìƒ‰ ë°°ê²½ */
            --dark-gray: #666666; /* ë¶€ì œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ (ê°€ë…ì„± ê°œì„ ) */
            --highlight-green: #3CB371;
            --btn-gray: #E0E0E0;
            --text-color: #000000;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            /* ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ìŠ¤í¬ë¡¤ ë°©ì§€ ë° ë·°í¬íŠ¸ ê³ ì • */
            overflow: hidden; 
            touch-action: manipulation; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* [ì•„ì´íŒ¨ë“œ 1920x1080 ë¹„ìœ¨ ì»¨í…Œì´ë„ˆ] */
        #app-container {
            width: 1920px;
            height: 1080px;
            max-width: 100vw;
            max-height: 100vh;
            position: relative;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease-in-out;
            /* í„°ì¹˜ ì˜ì—­ ì „ì²´ë¥¼ í™œì„±í™” */
            cursor: pointer; 
        }

        /* ========================================================= */
        /* [1. Intro í™”ë©´ ìŠ¤íƒ€ì¼ (ë‹¨ê³„ë³„ ì• ë‹ˆë©”ì´ì…˜)] */
        /* ========================================================= */

        /* ë¡œê³  í…ìŠ¤íŠ¸ ë°•ìŠ¤ */
        .logo-box {
            background: linear-gradient(135deg, var(--soft-green), var(--main-green));
            padding: 20px 40px; 
            border-radius: 25px;
            color: white;
            font-size: 2.5rem; 
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            cursor: default;
            transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            z-index: 10;
        }

        /* ----------------------- */
        /* ë‹¨ê³„ 1: ì´ˆê¸° í™”ë©´ */
        /* ----------------------- */
        #intro-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            transition: all 0.5s ease-in-out;
        }

        /* ----------------------- */
        /* ë‹¨ê³„ 2: ë¶€ì œ í…ìŠ¤íŠ¸ */
        /* ----------------------- */
        #subtitle {
            margin-top: 40px; /* ë¡œê³ ì™€ì˜ ê°„ê²© */
            font-size: 2.2rem; 
            font-weight: bold;
            color: var(--dark-gray); /* ì§™ì€ íšŒìƒ‰ */
            /* ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ìƒíƒœ */
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* ë¶€ì œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ */
        #intro-area.step-2 #subtitle {
            opacity: 1;
            transform: translateY(0);
        }

        /* ë‹¨ê³„ 2ì—ì„œ ë¡œê³  ìœ„ì¹˜ ì¡°ì • (ì‚´ì§ ìœ„ë¡œ) */
        #intro-area.step-2 .logo-box {
            transform: translateY(-50px); 
        }


        /* ----------------------- */
        /* ë‹¨ê³„ 3: ë²„íŠ¼ ê·¸ë£¹ */
        /* ----------------------- */

        /* ë‘ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ */
        #selection-buttons {
            display: flex;
            gap: 40px; 
            margin-top: 50px; /* ë¶€ì œì™€ ë²„íŠ¼ ê·¸ë£¹ ì‚¬ì´ ê°„ê²© */
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 10; /* ë²„íŠ¼ì´ í„°ì¹˜ë˜ë„ë¡ z-index í™•ë³´ */
        }

        /* ë‹¨ê³„ 3ì—ì„œ ë²„íŠ¼ ê·¸ë£¹ ë“±ì¥ */
        #intro-area.step-3 #selection-buttons {
            opacity: 1;
            transform: translateY(-100px); /* ì „ì²´ ê·¸ë£¹ê³¼ ë™ì¼í•˜ê²Œ ìƒë‹¨ ì´ë™ */
        }

        /* ë‹¨ê³„ 3ì—ì„œ ë¡œê³  ë° ë¶€ì œ ìœ„ì¹˜ ì¡°ì • (ì •ì¤‘ì•™ ê³ ë¥¸ ë¶„í¬) */
        /* ëª¨ë“  ìš”ì†Œê°€ ìƒë‹¨ìœ¼ë¡œ í•¨ê»˜ ì´ë™í•˜ë©° ì¤‘ì•™ì— ê³ ë¥´ê²Œ ë¶„í¬ */
        #intro-area.step-3 .logo-box {
            transform: translateY(-100px);
        }
        #intro-area.step-3 #subtitle {
            margin-top: 40px;
            transform: translateY(-100px);
        }
        
        .selection-btn {
            padding: 25px 60px; 
            border-radius: 20px;
            font-size: 1.8rem; 
            font-weight: bold;
            background-color: var(--btn-gray);
            color: var(--text-color);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            /* ë‹¨ê³„ 3ì—ì„œ ë²„íŠ¼ë§Œ ë…ë¦½ì ìœ¼ë¡œ í„°ì¹˜/í´ë¦­ ê°€ëŠ¥ */
            pointer-events: auto; 
        }

        .selection-btn:active {
            transform: scale(0.95);
        }

        /* ë‹¨ê³„ 3ì—ì„œëŠ” ì „ì²´ ì˜ì—­ì˜ í´ë¦­ì„ ë§‰ê³  ë²„íŠ¼ë§Œ í™œì„±í™” */
        #intro-area.step-3 {
            cursor: default;
        }

        /* ========================================================= */
        /* [2. Main í™”ë©´ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ì—…ë¡œë“œ í™”ë©´)] - ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */
        /* ========================================================= */

        /* Main í™”ë©´ ì»¨í…Œì´ë„ˆ (ì´ˆê¸° ìˆ¨ê¹€) */
        #main-content-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
            padding-top: 100px;
            box-sizing: border-box;
        }
        
        /* ----------------------- */
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ (ê°„ê²°í™”) */
        /* ----------------------- */

        /* í—¤ë”: ë¡œê³  (Main í™”ë©´ìš©) */
        header {
            width: 100%;
            height: 100px;
            display: none;
            align-items: center;
            justify-content: flex-start;
            padding-left: 50px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .upload-zone {
            width: 60%;
            height: 50%;
            border: 3px dashed var(--soft-green);
            border-radius: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #FAFAFA;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-text {
            font-size: 1.5rem;
            color: var(--text-gray);
            margin-top: 20px;
        }

        #file-input {
            display: none;
        }

        #status-text {
            font-size: 3rem;
            font-weight: bold;
            color: #888;
            line-height: 1.5;
            min-height: 200px;
        }

        .highlight-text {
            color: var(--highlight-green);
        }

        .button-group {
            display: none;
            margin-top: 50px;
            margin-bottom: 20px;
            gap: 40px;
            z-index: 5;
        }

        .action-btn {
            background-color: var(--pastel-gray);
            color: black;
            font-size: 1.8rem;
            padding: 20px 60px;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.1s, background-color 0.2s;
        }
        
        .action-btn.active {
            background-color: var(--main-green);
            color: white;
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.4);
        }

        #detail-view {
            width: 80%;
            height: 60%;
            background: white;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 30px; 
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 30px;
            width: 90%;
            max-width: 1200px;
            margin: 30px auto;
        }

        .step-box {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: left;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--main-green);
            margin-top: 5px;
            margin-bottom: 10px;
        }
        
        .step-img {
            width: 100%;
            height: 180px; 
            background-color: #ddd; 
            border-radius: 10px;
            margin-bottom: 15px;
            background-size: cover; 
            background-position: center;
            background-repeat: no-repeat;
        }

        .video-box {
            width: 90%;
            height: 90%;
            max-width: 1000px;
            max-height: 560px;
            margin: 0 auto;
            background-color: black;
            border-radius: 20px;
        }
        
        .video-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 20px;
        }

        .reset-bar {
            width: 100%;
            height: 80px;
            display: none;
            justify-content: center;
            position: absolute;
            bottom: 30px;
        }

        .reset-btn {
            background-color: #808080;
            color: white;
            font-size: 1.5rem;
            padding: 15px 50px;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #preview-img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 20px;
            margin-bottom: 30px;
            display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

    </style>
</head>
<body>

    <div id="app-container">
        <div id="intro-area">
            <div class="logo-box">ì–´ë–»ê²Œ? ğŸš®</div>
            <div id="subtitle" class="bold">ë¶„ë¦¬ìˆ˜ê±°ë¥¼ ë³´ë‹¤ ë” ì‰½ê²Œ.</div>
            
            <div id="selection-buttons">
                <div class="selection-btn" id="btn-practice">ì´ë ‡ê²Œ! ğŸš®</div>
                <div class="selection-btn" id="btn-start">ì–´ë–»ê²Œ? ğŸš®</div>
            </div>
        </div>

        <header id="app-header">
            <div class="logo-box" onclick="resetApp()">ì–´ë–»ê²Œ? ğŸš®</div>
        </header>

        <div id="main-content-area">
            
            <div class="upload-zone" id="upload-zone" onclick="triggerUpload()">
                <div style="font-size: 4rem;">ğŸ“·</div>
                <div class="upload-text">ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì“°ë ˆê¸° ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”</div>
            </div>
            <input type="file" id="file-input" accept="image/*" onchange="handleFileSelect(this)">

            <img id="preview-img" src="" alt="ì—…ë¡œë“œëœ ì“°ë ˆê¸°">
            <div id="status-text" style="display: none;"></div>

            <div class="button-group" id="btn-group">
                <button class="action-btn" onclick="showInstruction()">ë¶„ë¦¬ìˆ˜ê±° ë°©ë²•</button>
                <button class="action-btn" onclick="showVideo()">ë¶„ë¦¬ìˆ˜ê±° ì˜ìƒ</button>
            </div>

            <div id="detail-view"></div>
        </div>

        <div class="reset-bar" id="reset-bar">
            <div class="reset-btn" onclick="resetApp()">
                ë˜ë‹¤ì‹œ â™¾ï¸
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<script>
    // =========================================================
    // [1. í‹°ì²˜ë¸” ë¨¸ì‹  ëª¨ë¸ URL ì„¤ì •]
    const URL = "https://teachablemachine.withgoogle.com/models/zEph8gOIH/";
    // =========================================================

    // [ì½˜í…ì¸  ë§¤í•‘] (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    const RECYCLE_GUIDES = {
        "MilkisBottle": {
            category: "í”Œë¼ìŠ¤í‹± (í˜íŠ¸)",
            instruction: [
                { title: "ë‚´ìš©ë¬¼ ë¹„ìš°ê¸°", detail: "ë‚´ìš©ë¬¼ì„ ì™„ì „íˆ ë¹„ìš°ê³  ë¬¼ë¡œ ê¹¨ë—ì´ í—¹ê¶ˆì£¼ì„¸ìš”.", img: "static/HowTo_MilkisBottle_1.jpg" },
                { title: "ë¼ë²¨ ì œê±°", detail: "ìŒë£Œìˆ˜ë³‘ì˜ ë¹„ë‹ ë¼ë²¨(ëšœê»‘ í¬í•¨)ì€ ê¹”ë”í•˜ê²Œ ë–¼ì–´ëƒ…ë‹ˆë‹¤. (ì¼ë°˜ ì“°ë ˆê¸°ë¡œ ë²„ë¦¼)", img: "static/HowTo_MilkisBottle_2.jpg" },
                { title: "ì••ì°© í›„ ëšœê»‘ ë‹«ê¸°", detail: "ë³‘ì˜ ë¶€í”¼ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ìµœëŒ€í•œ ì°Œê·¸ëŸ¬ëœ¨ë¦¬ê³ , ì••ì¶•ëœ ìƒíƒœë¥¼ ìœ ì§€í•˜ë„ë¡ ëšœê»‘ì„ ë‹¤ì‹œ ë‹«ì•„ì¤ë‹ˆë‹¤.", img: "static/HowTo_MilkisBottle_3.jpg" },
                { title: "ë°°ì¶œ", detail: "íˆ¬ëª… í˜íŠ¸ë³‘ ìˆ˜ê±°í•¨ì— ë¶„ë¦¬ ë°°ì¶œí•©ë‹ˆë‹¤.", img: "static/HowTo_MilkisBottle_4.jpg" }
            ],
            video: "https://www.youtube.com/embed/6iQ5QvE7L1Y" 
        },
        "PpuPpuBulgogiflavor": {
            category: "ë¹„ë‹ í¬ì¥ì¬",
            instruction: [
                { title: "ë‚´ìš©ë¬¼ ë¹„ìš°ê¸°", detail: "ê³¼ì ë¶€ìŠ¤ëŸ¬ê¸° ë“± ë‚´ìš©ë¬¼ì„ ìµœëŒ€í•œ í„¸ì–´ëƒ…ë‹ˆë‹¤.", img: "static/HowTo_PpuPpu_1.jpg" },
                { title: "ì„¸ì²™/ì œê±°", detail: "ê¸°ë¦„ê¸°ë‚˜ ì´ë¬¼ì§ˆì´ ìˆë‹¤ë©´ ë¬¼ë¡œ í—¹êµ¬ê±°ë‚˜ ë‹¦ì•„ëƒ…ë‹ˆë‹¤. (ì´ë¬¼ì§ˆ ì œê±°ê°€ ì–´ë ¤ìš°ë©´ ì¢…ëŸ‰ì œ)", img: "static/HowTo_PpuPpu_2.jpg" },
                { title: "ê±´ì¡°", detail: "ë¬¼ê¸°ë¥¼ ì™„ì „íˆ ë§ë ¤ì¤ë‹ˆë‹¤.", img: "static/HowTo_PpuPpu_3.jpg" },
                { title: "ë°°ì¶œ", detail: "ê¹¨ë—í•œ ë¹„ë‹ë¥˜ë§Œ ë”°ë¡œ ëª¨ì•„ ë¹„ë‹ë¥˜ ìˆ˜ê±°í•¨ì— ë°°ì¶œí•©ë‹ˆë‹¤.", img: "static/HowTo_PpuPpu_4.jpg" }
            ],
            video: "https://www.youtube.com/embed/PpuPpu_ID" 
        }
    };
    // =========================================================

    // [2. DOM ì—˜ë¦¬ë¨¼íŠ¸ ë° ìƒíƒœ ë³€ìˆ˜]
    const appContainer = document.getElementById('app-container');
    const introArea = document.getElementById('intro-area');
    const btnStart = document.getElementById('btn-start'); 
    const mainContentArea = document.getElementById('main-content-area');
    const mainHeader = document.getElementById('app-header');

    // ê¸°ì¡´ Main í™”ë©´ ìš”ì†Œë“¤ (ê¸°ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ ì¬ì„ ì–¸)
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const previewImg = document.getElementById('preview-img');
    const statusText = document.getElementById('status-text');
    const btnGroup = document.getElementById('btn-group');
    const detailView = document.getElementById('detail-view');
    const resetBar = document.getElementById('reset-bar');
    const instructionBtn = btnGroup.querySelector('.action-btn:nth-child(1)');
    const videoBtn = btnGroup.querySelector('.action-btn:nth-child(2)');

    let currentStep = 1; 
    let model = null; 
    let maxPredictions;
    let loadingInterval = null; 
    let isModelLoading = false; 
    let detectedCategory = ""; 
    let detectedSpecific = ""; 
    let currentGuide = null; 

    // ---------------------------------------------------------
    // [A. Intro ì• ë‹ˆë©”ì´ì…˜ ë¡œì§ - í„°ì¹˜ í™˜ê²½ ìµœì í™”]
    // ---------------------------------------------------------

    // 1-1. ì´ˆê¸°í™” ì‹œ ëª¨ë¸ ë¡œë”© ì‹œì‘
    window.onload = initAI; 

    // ì´ˆê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupActionListener();

    function setupActionListener() {
        // ë°ìŠ¤í¬í†± í´ë¦­ê³¼ ëª¨ë°”ì¼ í„°ì¹˜(í„°ì¹˜ ì‹œì‘) ì´ë²¤íŠ¸ ëª¨ë‘ ì²˜ë¦¬
        appContainer.addEventListener('click', handleUserAction);
        appContainer.addEventListener('touchstart', handleUserAction);
    }

    function disableActionListener() {
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        appContainer.removeEventListener('click', handleUserAction);
        appContainer.removeEventListener('touchstart', handleUserAction);
    }


    function handleUserAction(event) {
        // ì´ë²¤íŠ¸ê°€ ìµœì¢… ë²„íŠ¼ ê·¸ë£¹ ë‚´ì—ì„œ ë°œìƒí•œ ê²½ìš° ë¬´ì‹œ (ë²„íŠ¼ ê³ ìœ  ê¸°ëŠ¥ í™œì„±í™”)
        if (currentStep === 3 && event.target.closest('#selection-buttons')) {
            return;
        }

        // í„°ì¹˜ ì´ë²¤íŠ¸ì˜ ê²½ìš°, ê¸°ë³¸ ë™ì‘(ìŠ¤í¬ë¡¤, í™•ëŒ€ ë“±) ë°©ì§€
        if (event.type === 'touchstart') {
            event.preventDefault(); 
        }
        
        // í„°ì¹˜ ë””ë°”ì´ìŠ¤ì—ì„œ touchstart í›„ click ì´ë²¤íŠ¸ê°€ ì¤‘ë³µ ë°œìƒí•˜ëŠ” ê²ƒì„ ë°©ì§€
        if (event.type === 'click' && event.touches && event.touches.length > 0) {
            return; 
        }

        if (currentStep === 1) {
            // ë‹¨ê³„ 1 -> ë‹¨ê³„ 2 ì „í™˜
            introArea.classList.add('step-2');
            currentStep = 2;
            // ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ê¸° ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ì„¤ì • (ë””ë°”ìš´ì‹±)
            disableActionListener();
            setTimeout(() => {
                setupActionListener();
            }, 700); 
            
        } else if (currentStep === 2) {
            // ë‹¨ê³„ 2 -> ë‹¨ê³„ 3 ì „í™˜
            introArea.classList.add('step-3');
            currentStep = 3;
            // ìµœì¢… ë‹¨ê³„ì— ë„ë‹¬í–ˆìœ¼ë¯€ë¡œ ë°°ê²½ í„°ì¹˜ ì´ë²¤íŠ¸ ì˜êµ¬ ë¹„í™œì„±í™”
            disableActionListener(); 
        }
    }

    // 1-3. ìµœì¢… ë²„íŠ¼ í´ë¦­ ì‹œ Main í™”ë©´ìœ¼ë¡œ ì „í™˜
    btnStart.addEventListener('click', enterMainScreen);

    function enterMainScreen() {
        if (currentStep !== 3) return; 

        // Intro í™”ë©´ ìˆ¨ê¹€
        introArea.style.display = 'none';
        
        // Main í™”ë©´ í‘œì‹œ
        mainContentArea.style.display = 'flex';
        mainHeader.style.display = 'flex'; 
        
        setTimeout(() => {
            mainContentArea.style.opacity = 1;
        }, 10); 
    }


    // ---------------------------------------------------------
    // [B. ê¸°ì¡´ Main í™”ë©´ ë¡œì§ (ìœ ì§€)]
    // ---------------------------------------------------------

    async function initAI() {
        if (isModelLoading) return; 
        isModelLoading = true;

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        
        try {
            await tf.ready();
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            console.log("AI Model loaded successfully.");
        } catch (e) {
            console.error("ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨:", e);
            model = null; 
        } finally {
            isModelLoading = false;
        }
    }

    function triggerUpload() { 
        if (!model || isModelLoading) {
             alert("AI ëª¨ë¸ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
             return;
        }
        fileInput.click(); 
    }

    function handleFileSelect(input) {
        if (!model || isModelLoading) {
            alert("AI ëª¨ë¸ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadZone.style.display = 'none';
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                statusText.style.display = 'block';
                
                previewImg.onload = function() {
                    startDetectionProcess();
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function startDetectionProcess() {
        let dots = 0;
        loadingInterval = setInterval(() => {
            dots = (dots % 3) + 1;
            statusText.innerHTML = `ê°ì§€ì¤‘ ${".".repeat(dots)}`;
        }, 300);

        let prediction;
        try {
            prediction = await model.predict(previewImg);
        } catch (e) {
            clearInterval(loadingInterval);
            loadingInterval = null;
            statusText.innerHTML = "âŒ ê°ì§€ ì‹¤íŒ¨: ì´ë¯¸ì§€ ì˜¤ë¥˜ ë˜ëŠ” ëª¨ë¸ ì˜ˆì¸¡ ë¬¸ì œ";
            return;
        }

        let highestProbability = 0;
        let bestClass = "";

        for (let i = 0; i < maxPredictions; i++) {
            if (prediction[i].probability > highestProbability) {
                highestProbability = prediction[i].probability;
                bestClass = prediction[i].className;
            }
        }

        clearInterval(loadingInterval);
        loadingInterval = null;

        const splitName = bestClass.split('_');
        
        if (splitName.length >= 2) {
            detectedSpecific = splitName[1]; 
        } else {
            detectedSpecific = bestClass;
        }
        
        currentGuide = RECYCLE_GUIDES[detectedSpecific];

        if (!currentGuide) {
             detectedCategory = "ì •ë³´ ì—†ìŒ";
             currentGuide = { 
               category: "ì¼ë°˜ì“°ë ˆê¸° ë˜ëŠ” ì •ë³´ ì—†ìŒ",
               instruction: [{ title: "ì •ë³´ ì—†ìŒ", detail: "í•´ë‹¹ í’ˆëª©ì˜ ë¶„ë¦¬ìˆ˜ê±° ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¢…ëŸ‰ì œ ë´‰íˆ¬ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.", img: "" }], 
               video: "" 
             };
        }
        detectedCategory = currentGuide.category; 
        
        showFirstDetection();
    }

    function showFirstDetection() {
        statusText.innerHTML = `ì•„í•˜ !<br>ì´ ì“°ë ˆê¸°ëŠ” <span class="highlight-text">${detectedCategory}</span>ì´êµ°ìš”!`;
        setTimeout(() => { showSecondDetection(); }, 2000);
    }

    function showSecondDetection() {
        statusText.innerHTML = `ì•„í•˜ !<br>ì´ ì“°ë ˆê¸°ëŠ” <span class="highlight-text">${detectedSpecific}</span>ì´êµ°ìš”!`;
        setTimeout(() => { showComplete(); }, 2000);
    }

    function showComplete() {
        previewImg.style.display = 'none'; 
        statusText.innerHTML = `ê°ì§€ ì™„ë£Œ ! ğŸŒ¿`;
        statusText.style.color = "var(--main-green)"; 
        btnGroup.style.display = 'flex';
        resetBar.style.display = 'flex'; 
        
        showInstruction(); 
    }

    function showInstruction() {
        if (!currentGuide) return;
        
        instructionBtn.classList.add('active');
        videoBtn.classList.remove('active');

        statusText.style.display = 'none'; 
        detailView.style.display = 'flex';
        
        const steps = currentGuide.instruction;

        let stepHtml = '';
        steps.forEach((step, index) => {
            stepHtml += `
                <div class="step-box">
                    <div class="step-img" style="background-image: url('${step.img ? step.img : 'placeholder.png'}');">
                        ${!step.img ? 'ì‚¬ì§„ ì¤€ë¹„ì¤‘' : ''}
                    </div>
                    <div class="step-title">${index + 1}. ${step.title}</div>
                    <div>${step.detail}</div>
                </div>
            `;
        });

        detailView.innerHTML = `
            <h2 style="color:var(--main-green); margin-bottom:20px;">ë¶„ë¦¬ìˆ˜ê±° ë°©ë²• (${detectedSpecific})</h2>
            <div class="grid-container">
                ${stepHtml}
            </div>
        `;
    }

    function showVideo() {
        if (!currentGuide) return;

        instructionBtn.classList.remove('active');
        videoBtn.classList.add('active');

        statusText.style.display = 'none';
        detailView.style.display = 'flex';

        if (currentGuide.video) {
             detailView.innerHTML = `
                 <h2 style="color:var(--main-green); margin-bottom:20px;">ë¶„ë¦¬ìˆ˜ê±° ì˜ìƒ (${detectedSpecific})</h2>
                 <div class="video-box">
                     <iframe class="video-iframe" 
                         src="${currentGuide.video}" 
                         title="ë¶„ë¦¬ìˆ˜ê±° ê°€ì´ë“œ ì˜ìƒ"
                         frameborder="0" 
                         allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                         allowfullscreen>
                     </iframe>
                 </div>
             `;
        } else {
             detailView.innerHTML = `<h2 style="color:red; margin-bottom:20px;">ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h2>`;
        }
    }

    function resetApp() {
        if (loadingInterval) {
            clearInterval(loadingInterval);
            loadingInterval = null;
        }

        mainContentArea.style.display = 'none';
        mainContentArea.style.opacity = 0;
        mainHeader.style.display = 'none';

        introArea.style.display = 'flex';
        introArea.classList.remove('step-2', 'step-3');
        currentStep = 1;
        
        uploadZone.style.display = 'flex';
        fileInput.value = ''; 
        previewImg.style.display = 'none';
        statusText.style.display = 'none';
        statusText.style.color = '#888';
        btnGroup.style.display = 'none';
        detailView.style.display = 'none';
        resetBar.style.display = 'none';
        statusText.innerHTML = '';
        instructionBtn.classList.remove('active');
        videoBtn.classList.remove('active');
        
        // ì´ˆê¸°í™” í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ì„¤ì •
        setupActionListener();
    }
</script>
</body>
</html>
